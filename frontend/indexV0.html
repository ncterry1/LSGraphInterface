<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LSGraphInterface</title>
  <!-- Cytoscape.js -->
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    body{margin:0;display:flex;flex-direction:column;height:100vh;background:#1f2937;color:#cbd5e1;font-family:system-ui,sans-serif}
    #toolbar{display:flex;gap:0.5rem;padding:0.4rem;background:#111827;align-items:center}
    #cy{flex:1 1 auto;min-height:0}
    #analysis{white-space:pre-wrap;max-height:20vh;overflow:auto;padding:0.5rem;background:#0f172a}
    select,button{background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:0.35rem 0.6rem;cursor:pointer}
  </style>
</head>
<body>
  <div id="toolbar">
    <label style="font-size:.85rem">Layout:
      <select id="layoutSelect">
        <option value="cose">CoSE</option>
        <option value="concentric">Concentric</option>
        <option value="grid">Grid</option>
        <option value="breadthfirst">Breadth‑First</option>
      </select>
    </label>
    <button id="analyzeBtn" disabled>Analyze 2 Nodes</button>
  </div>
  <div id="cy"></div>
  <pre id="analysis"></pre>

<script>
let cy, selected=[];
const LAYOUT_OPTS={
  cose:{name:'cose',padding:10},
  concentric:{name:'concentric',padding:10,concentric:n=>n.degree(),levelWidth:()=>1},
  grid:{name:'grid',padding:10},
  breadthfirst:{name:'breadthfirst',padding:10,directed:true}
};

function applyLayout(name){cy.layout(LAYOUT_OPTS[name]).run();}

document.getElementById('layoutSelect').onchange=e=>applyLayout(e.target.value);

document.getElementById('analyzeBtn').onclick=async()=>{
  if(selected.length!==2)return;
  const infos=selected.map(n=>`Node ${n.id()}: ${n.data('email')}`).join('');
  const incEdges=cy.edges().filter(e=>selected.some(n=>[e.data('source'),e.data('target')].includes(n.id())));
  const relInfo=incEdges.map(e=>`Edge ${e.id()} (${e.data('subject')||'n/a'})`).join('')||'No incident edges.';
  const neighbours=[...new Set(incEdges.map(e=>[e.source(),e.target()]).flat())].filter(n=>!selected.includes(n));
  const neighbourInfo=neighbours.map(n=>`Node ${n.id()}: ${n.data('email')}`).join('')||'No neighbour nodes.';
  const prompt=`Analyze:
${infos}

Edges:
${relInfo}

Neighbours:
${neighbourInfo}`;
  const res=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})}).then(r=>r.json());
  document.getElementById('analysis').textContent=res.response;
};

fetch('/api/graph').then(r=>r.json()).then(({elements})=>{
  cy=cytoscape({container:document.getElementById('cy'),elements,
    style:[
      {selector:'node',style:{label:'data(email)','background-color':'#3b82f6',color:'#ffffff','text-valign':'center','text-halign':'center','font-size':'11px','text-outline-width':2,'text-outline-color':'#3b82f6'}},
      {selector:'edge',style:{label:'data(subject)','curve-style':'bezier','line-color':'#64748b','target-arrow-shape':'triangle','target-arrow-color':'#64748b','font-size':'9px',color:'#cbd5e1','text-background-color':'#334155','text-background-opacity':1,'text-background-shape':'roundrectangle','text-rotation':'autorotate'}},
      {selector:'.selected',style:{'background-color':'#facc15','line-color':'#facc15','target-arrow-color':'#facc15',color:'#ffffff','font-weight':'bold','text-outline-width':0}}
    ]
  });
  applyLayout('cose');
  cy.on('tap','node',evt=>{
    const node=evt.target;
    if(node.hasClass('selected')){node.removeClass('selected');selected=selected.filter(n=>n.id()!==node.id());}
    else{if(selected.length===2){selected[0].removeClass('selected');selected.shift();}node.addClass('selected');selected.push(node);} 
    document.getElementById('analyzeBtn').disabled=selected.length!==2;
  });
});
</script>
</body>
</html>
