<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LSGraphInterface</title>

  <!-- Cytoscape.js for graph visualization -->
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>

  <!-- Styles -->
  <style>
    /* Base page layout */
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #1f2937;
      color: #cbd5e1;
      font-family: system-ui, sans-serif;
    }

    /* Top toolbar with layout selector and analyze button */
    #toolbar {
      display: flex;
      gap: 0.5rem;
      padding: 0.4rem;
      background: #111827;
      align-items: center;
    }

    /* Cytoscape graph container */
    #cy {
      flex: 1 1 auto;
      min-height: 0;
    }

    /* Analysis output area */
    #analysis {
      white-space: pre-wrap;
      max-height: 20vh;
      overflow: auto;
      padding: 0.5rem;
      background: #0f172a;
    }

    /* Shared styles for selects and buttons */
    select,
    button {
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <div id="toolbar">

    <!-- Layout dropdown -->
    <label style="font-size:0.85rem;">
      Layout:
      <select id="layoutSelect">
        <option value="cose">CoSE</option>
        <option value="concentric">Concentric</option>
        <option value="grid">Grid</option>
        <option value="breadthfirst">Breadth-First</option>
      </select>
    </label>

    <!-- Analyze button (enabled when two nodes are selected) -->
    <button id="analyzeBtn" disabled>
      Analyze 2 Nodes
    </button>
    <!-- Add these inside your #toolbar div, alongside the layout select and analyze button -->
    <label style="font-size:0.85rem;">
      Repel:
      <input
        type="range"
        id="edgeLenSlider"
        min="20" max="200"
        value="100"
      />
      <span id="edgeLenVal">100</span>
    </label>

    <label style="font-size:0.85rem;">
      Spacing:
      <input
        type="range"
        id="nodeSpacingSlider"
        min="20" max="200"
        value="50"
      />
      <span id="nodeSpacingVal">50</span>
    </label>

    <!-- Preset layout profiles -->
    <button id="presetTight">Tight</button>
    <button id="presetBalanced">Balanced</button>
    <button id="presetSpacious">Spacious</button>
  </div>

  <!-- Graph display -->
  <div id="cy"></div>

  <!-- Text output for analysis results -->
  <pre id="analysis"></pre>

  <!-- Main JavaScript -->
  <script>
    // Cytoscape instance and currently selected nodes
    let cy;
    let selected = [];

    // Configuration for different layout algorithms
    const LAYOUT_OPTS = {
      concentric: {
        name: 'concentric',
        padding: 10,
        concentric: node => node.degree(),
        levelWidth: () => 2,
        minNodeSpacing: 50
      },
      grid: {
        name: 'grid',
        padding: 10
      },
      breadthfirst: {
        name: 'breadthfirst',
        padding: 10,
        directed: true
      }
    };

    /**
     * Apply a layout by name.
     * @param {string} name - One of the keys in LAYOUT_OPTS
     */
    function applyLayout(name) {
      cy.layout(LAYOUT_OPTS[name]).run();
    }

    // Handle layout selection changes
    document.getElementById('layoutSelect').onchange = e => applyLayout(e.target.value);

    // When the "Analyze 2 Nodes" button is clicked
    document.getElementById('analyzeBtn').onclick = async () => {
      if (selected.length !== 2) return;

      // Build descriptions for selected nodes
      const infos = selected.map(n => `Node ${n.id()}: ${n.data('email')}\n`).join('');

      // Gather incident edges
      const incidentEdges = cy.edges().filter(e =>
        selected.some(n =>
          [e.data('source'), e.data('target')].includes(n.id())
        )
      );

      // Describe edges
      const relInfo =
        incidentEdges
          .map(e => `Edge ${e.id()} (${e.data('subject') || 'n/a'})\n`)
          .join('') || 'No incident edges.\n';

      // Identify neighbor nodes
      const neighbours = [
        ...new Set(
          incidentEdges
            .map(e => [e.source(), e.target()])
            .flat()
        )
      ].filter(n => !selected.includes(n));

      // Describe neighbor nodes
      const neighbourInfo =
        neighbours
          .map(n => `Node ${n.id()}: ${n.data('email')}\n`)
          .join('') || 'No neighbour nodes.\n';

      // Construct and send prompt
      const prompt = `Analyze:\n${infos}Edges:\n${relInfo}Neighbours:\n${neighbourInfo}`;
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      }).then(r => r.json());

      document.getElementById('analysis').textContent = res.response;
    };

      // 1) Read sliders and return COSE parameters
    function getCoseParams() {
      const edgeLen  = +document.getElementById('edgeLenSlider').value;
      const nodeSpace = +document.getElementById('nodeSpacingSlider').value;
      document.getElementById('edgeLenVal').textContent = edgeLen;
      document.getElementById('nodeSpacingVal').textContent = nodeSpace;
      return {
        name: 'cose',
        idealEdgeLength: edgeLen,
        nodeSpacing: () => nodeSpace,
        padding: 10
      };
    }

    // 2) Apply the dynamic COSE layout
    function applyCose() {
      cy.layout(getCoseParams()).run();
    }

    // 3) Wire sliders to re-layout on change
    document.getElementById('edgeLenSlider').oninput        = applyCose;
    document.getElementById('nodeSpacingSlider').oninput     = applyCose;

    // 4) Preset buttons
    document.getElementById('presetTight').onclick    = () => {
      document.getElementById('edgeLenSlider').value = 50;
      document.getElementById('nodeSpacingSlider').value = 20;
      applyCose();
    };
    document.getElementById('presetBalanced').onclick = () => {
      document.getElementById('edgeLenSlider').value = 100;
      document.getElementById('nodeSpacingSlider').value = 50;
      applyCose();
    };
    document.getElementById('presetSpacious').onclick = () => {
      document.getElementById('edgeLenSlider').value = 200;
      document.getElementById('nodeSpacingSlider').value = 100;
      applyCose();
    };

    // Fetch graph data and initialize Cytoscape
    fetch('/api/graph')
      .then(r => r.json())
      .then(({ elements }) => {
        cy = cytoscape({
          container: document.getElementById('cy'),
          elements: elements,
          style: [
            {
              selector: 'node',
              style: {
                label: 'data(email)',
                'background-color': '#3b82f6',
                color: '#ffffff',
                'text-valign': 'center',
                'text-halign': 'center',
                'font-size': '11px',
                'text-outline-width': 2,
                'text-outline-color': '#3b82f6'
              }
            },
            {
              selector: 'edge',
              style: {
                label: 'data(subject)',
                'curve-style': 'bezier',
                'line-color': '#64748b',
                'target-arrow-shape': 'triangle',
                'target-arrow-color': '#64748b',
                'font-size': '9px',
                color: '#cbd5e1',
                'text-background-color': '#334155',
                'text-background-opacity': 1,
                'text-background-shape': 'roundrectangle',
                'text-rotation': 'autorotate'
              }
            },
            {
              selector: '.selected',
              style: {
                'background-color': '#facc15',
                'line-color': '#facc15',
                'target-arrow-color': '#facc15',
                color: '#ffffff',
                'font-weight': 'bold',
                'text-outline-width': 0
              }
            }
          ]
        });

        applyCose();

        // Node selection logic
        cy.on('tap', 'node', evt => {
          const node = evt.target;
          if (node.hasClass('selected')) {
            node.removeClass('selected');
            selected = selected.filter(n => n.id() !== node.id());
          } else {
            if (selected.length === 2) {
              selected[0].removeClass('selected');
              selected.shift();
            }
            node.addClass('selected');
            selected.push(node);
          }
          document.getElementById('analyzeBtn').disabled = selected.length !== 2;
        });
      });
  </script>
</body>
</html>
